# test_burnin.py æ¶æ§‹èªªæ˜

## 1. setup_test_class çš„ä½œç”¨

`setup_test_class` æ˜¯ä¸€å€‹ pytest fixtureï¼Œç”¨æ–¼åœ¨æ•´å€‹æ¸¬è©¦é¡åˆ¥åŸ·è¡Œå‰é€²è¡Œä¸€æ¬¡æ€§çš„åˆå§‹åŒ–è¨­å®šã€‚

### ä½ç½®
- æª”æ¡ˆï¼š[tests/integration/stc1685/test_burnin.py](test_burnin.py#L32-L67)
- é¡åˆ¥ï¼š`TestSTC1685BurnIN`

### ç‰¹æ€§
- **scope="class"**ï¼šåœ¨æ•´å€‹æ¸¬è©¦é¡åˆ¥åŸ·è¡ŒæœŸé–“åªåŸ·è¡Œä¸€æ¬¡
- **autouse=True**ï¼šè‡ªå‹•åŸ·è¡Œï¼Œä¸éœ€è¦åœ¨æ¸¬è©¦å‡½æ•¸ä¸­æ˜ç¢ºæŒ‡å®š

### åŸ·è¡Œæ™‚æ©Ÿ
```
æ¸¬è©¦é–‹å§‹
    â†“
setup_test_class (åŸ·è¡Œ yield å‰çš„ç¨‹å¼ç¢¼)
    â†“
test_01_precondition
test_02_install_burnin
test_03_partition_disk
...
    â†“
setup_test_class (åŸ·è¡Œ yield å¾Œçš„ç¨‹å¼ç¢¼)
    â†“
æ¸¬è©¦çµæŸ
```

### ä¸»è¦åŠŸèƒ½

#### Setup éšæ®µï¼ˆyield ä¹‹å‰ï¼‰
1. **å„²å­˜ä¸¦åˆ‡æ›å·¥ä½œç›®éŒ„**
   ```python
   cls.original_cwd = os.getcwd()
   test_dir = Path(__file__).parent
   os.chdir(test_dir)
   ```
   - å„²å­˜åŸå§‹å·¥ä½œç›®éŒ„
   - åˆ‡æ›åˆ°æ¸¬è©¦æª”æ¡ˆæ‰€åœ¨ç›®éŒ„
   - ç¢ºä¿ç›¸å°è·¯å¾‘æ­£ç¢º

2. **è¼‰å…¥æ¸¬è©¦é…ç½®**
   ```python
   config_path = Path(__file__).parent / "Config" / "Config.json"
   with open(config_path) as f:
       cls.config = json.load(f)
   ```
   - è®€å– `Config/Config.json`
   - å°‡é…ç½®å­˜å…¥ `cls.config` ä¾›æ‰€æœ‰æ¸¬è©¦å‡½æ•¸ä½¿ç”¨

3. **åˆå§‹åŒ–æ—¥èªŒç³»çµ±**
   ```python
   logger.logConfig()
   logger.LogEvt("STC-1685: BurnIN Test Starting")
   ```

4. **è¨­å®šå·¥å…·è·¯å¾‘**
   ```python
   cls.bin_path = Path(__file__).parent / "bin"
   ```

#### Teardown éšæ®µï¼ˆyield ä¹‹å¾Œï¼‰
1. **è¨˜éŒ„æ¸¬è©¦å®Œæˆ**
2. **é‚„åŸåŸå§‹å·¥ä½œç›®éŒ„**
   ```python
   os.chdir(cls.original_cwd)
   ```

---

## 2. BaseTestCase ç¹¼æ‰¿çš„ä½œç”¨

### ä½ç½®
- æª”æ¡ˆï¼š[framework/base_test.py](../../../framework/base_test.py)
- é¡åˆ¥ï¼š`BaseTestCase`

### ç¹¼æ‰¿é—œä¿‚
```python
class TestSTC1685BurnIN(BaseTestCase):
    """ç¹¼æ‰¿ BaseTestCase å–å¾—æ¸¬è©¦æ¡†æ¶çš„æ¨™æº–åŠŸèƒ½"""
```

### BaseTestCase æä¾›çš„åŠŸèƒ½

#### 2.1 Class-level Setup/Teardown
```python
@pytest.fixture(scope="class", autouse=True)
def setup_teardown_class(self, request):
```

**åŠŸèƒ½ï¼š**
- åˆå§‹åŒ–æ¸¬è©¦åç¨±ã€æ—¥èªŒè·¯å¾‘
- å»ºç«‹ `RebootManager` ç”¨æ–¼é‡å•Ÿæ¢å¾©
- æ”¯æ´é‡å•Ÿå¾Œæ¢å¾©æ¸¬è©¦
- æ¸¬è©¦çµæŸå¾Œæ¸…ç†ç’°å¢ƒ

**é‡å•Ÿæ¢å¾©æ©Ÿåˆ¶ï¼š**
```python
if not cls.reboot_mgr.is_recovering():
    # é¦–æ¬¡åŸ·è¡Œï¼šå®Œæ•´åˆå§‹åŒ–
    setup_test_environment(cls.log_path)
else:
    # é‡å•Ÿå¾Œï¼šæ¢å¾©æ¸¬è©¦
    print("Recovering test...")
```

#### 2.2 Function-level Setup/Teardown
```python
@pytest.fixture(autouse=True)
def setup_teardown_function(self, request):
```

**åŠŸèƒ½ï¼š**
- æ¯å€‹æ¸¬è©¦å‡½æ•¸åŸ·è¡Œå‰å¾Œè‡ªå‹•åŸ·è¡Œ
- æª¢æŸ¥æ¸¬è©¦æ˜¯å¦å·²å®Œæˆï¼ˆé¿å…é‡è¤‡åŸ·è¡Œï¼‰
- æ¨™è¨˜æ¸¬è©¦å®Œæˆç‹€æ…‹

**è·³éå·²å®Œæˆçš„æ¸¬è©¦ï¼š**
```python
if self.reboot_mgr.is_completed(test_name):
    pytest.skip(f"{test_name} already completed")
```

#### 2.3 è¼”åŠ©æ–¹æ³•

**get_config(key, default=None)**
- è®€å–é…ç½®æª”æ¡ˆ `Config/Config.json`
- æä¾›é è¨­å€¼æ”¯æ´

**log(message)**
- çµ±ä¸€çš„æ—¥èªŒè¼¸å‡ºæ ¼å¼
- `print(f"[LOG] {message}")`

---

## 3. Fixture åŸ·è¡Œé †åº

åœ¨ `TestSTC1685BurnIN` ä¸­ï¼Œå› ç‚ºç¹¼æ‰¿äº† `BaseTestCase` ä¸¦ä¸”å®šç¾©äº†è‡ªå·±çš„ fixtureï¼Œæ‰€ä»¥æœƒæœ‰**å¤šå€‹ fixture åŒæ™‚ä½œç”¨**ã€‚

### å®Œæ•´çš„åŸ·è¡Œé †åº

```
æ¸¬è©¦é–‹å§‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. BaseTestCase.setup_teardown_class (yield å‰)            â”‚
â”‚    - åˆå§‹åŒ– test_name, log_path, reboot_mgr                â”‚
â”‚    - æª¢æŸ¥æ˜¯å¦ç‚ºé‡å•Ÿæ¢å¾©                                      â”‚
â”‚    - å¦‚æœæ˜¯é¦–æ¬¡åŸ·è¡Œï¼šsetup_test_environment()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TestSTC1685BurnIN.setup_test_class (yield å‰)           â”‚
â”‚    - åˆ‡æ›å·¥ä½œç›®éŒ„                                            â”‚
â”‚    - è¼‰å…¥ Config.json                                       â”‚
â”‚    - åˆå§‹åŒ– logger                                          â”‚
â”‚    - è¨­å®š bin_path                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åŸ·è¡Œæ¯å€‹æ¸¬è©¦å‡½æ•¸ (å¾ªç’°)                                   â”‚
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ BaseTestCase.setup_teardown_function (yield å‰)â”‚    â”‚
â”‚    â”‚ - æª¢æŸ¥æ¸¬è©¦æ˜¯å¦å·²å®Œæˆ                            â”‚    â”‚
â”‚    â”‚ - å¦‚å·²å®Œæˆå‰‡è·³é                                â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ test_01_precondition                            â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ BaseTestCase.setup_teardown_function (yield å¾Œ)â”‚    â”‚
â”‚    â”‚ - æ¨™è¨˜æ¸¬è©¦å·²å®Œæˆ                                â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                                    â”‚
â”‚    (é‡è¤‡åŸ·è¡Œ test_02, test_03, ...)                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. TestSTC1685BurnIN.setup_test_class (yield å¾Œ)           â”‚
â”‚    - è¨˜éŒ„æ¸¬è©¦å®Œæˆ                                            â”‚
â”‚    - é‚„åŸåŸå§‹å·¥ä½œç›®éŒ„                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. BaseTestCase.setup_teardown_class (yield å¾Œ)            â”‚
â”‚    - æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ¸¬è©¦éƒ½å®Œæˆ                                  â”‚
â”‚    - å¦‚æœå®Œæˆï¼šcleanup_test_environment()                   â”‚
â”‚    - æ¸…ç† reboot_mgr                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ¸¬è©¦çµæŸ
```

### é—œéµé‡é»

1. **å…©å€‹ class-scope fixture éƒ½æœƒåŸ·è¡Œ**
   - `BaseTestCase.setup_teardown_class`ï¼ˆçˆ¶é¡åˆ¥ï¼‰
   - `TestSTC1685BurnIN.setup_test_class`ï¼ˆå­é¡åˆ¥ï¼‰

2. **åŸ·è¡Œé †åºæ˜¯ã€Œå…ˆçˆ¶å¾Œå­ï¼Œå…ˆé€²å¾Œå‡ºã€**
   - Setupï¼šçˆ¶é¡åˆ¥ â†’ å­é¡åˆ¥
   - Teardownï¼šå­é¡åˆ¥ â†’ çˆ¶é¡åˆ¥
   - å°±åƒæ´‹è”¥ä¸€æ¨£çš„å±¤æ¬¡çµæ§‹

3. **Function-level fixture åœ¨æ¯å€‹æ¸¬è©¦å‰å¾ŒåŸ·è¡Œ**
   - æª¢æŸ¥æ˜¯å¦å·²å®Œæˆï¼ˆé¿å…é‡è¤‡åŸ·è¡Œï¼‰
   - åŸ·è¡Œæ¸¬è©¦
   - æ¨™è¨˜å®Œæˆç‹€æ…‹

### å¯¦éš›ç¯„ä¾‹

å‡è¨­åŸ·è¡Œæ¸¬è©¦ï¼Œå®Œæ•´çš„ log è¼¸å‡ºé †åºæœƒæ˜¯ï¼š

```
==================================================
Setting up test: TestSTC1685BurnIN              â† BaseTestCase.setup_teardown_class
==================================================
Changed working directory to: ...               â† setup_test_class
STC-1685: BurnIN Test Starting                  â† setup_test_class

--- Starting: test_01_precondition ---          â† setup_teardown_function
[TEST_01] Precondition setup started            â† test_01 åŸ·è¡Œ
[TEST_01] Precondition completed                â† test_01 åŸ·è¡Œ
--- Completed: test_01_precondition ---         â† setup_teardown_function

--- Starting: test_02_install_burnin ---        â† setup_teardown_function
[TEST_02] BurnIN installation started           â† test_02 åŸ·è¡Œ
[TEST_02] BurnIN installation completed         â† test_02 åŸ·è¡Œ
--- Completed: test_02_install_burnin ---       â† setup_teardown_function

... (å…¶ä»–æ¸¬è©¦)

STC-1685 Test Completed                         â† setup_test_class (yield å¾Œ)
==================================================
All tests completed, cleaning up...             â† setup_teardown_class (yield å¾Œ)
==================================================
```

---

## 4. ç‚ºä»€éº¼éœ€è¦å…©å±¤ Fixtureï¼Ÿ

### BaseTestCase.setup_teardown_class çš„ä½œç”¨èˆ‡æ™‚æ©Ÿ

**ä½œç”¨ï¼š**
1. **æä¾›é€šç”¨çš„æ¸¬è©¦æ¡†æ¶åŠŸèƒ½**ï¼ˆæ‰€æœ‰æ¸¬è©¦éƒ½éœ€è¦ï¼‰
   - å»ºç«‹ `RebootManager` è¿½è¹¤æ¸¬è©¦é€²åº¦
   - åˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒï¼ˆå»ºç«‹ç›®éŒ„ï¼‰
   - æ”¯æ´é‡å•Ÿæ¢å¾©æ©Ÿåˆ¶
   - æ¸¬è©¦çµæŸå¾Œæ¸…ç†ç’°å¢ƒ

2. **é‡å•Ÿç‹€æ…‹åˆ¤æ–·**
   ```python
   cls.reboot_mgr = RebootManager()
   if not cls.reboot_mgr.is_recovering():
       # é¦–æ¬¡åŸ·è¡Œ
   else:
       # é‡å•Ÿå¾Œæ¢å¾©
   ```

**ä½¿ç”¨æ™‚æ©Ÿï¼š**
- ç•¶ä½ ç¹¼æ‰¿ `BaseTestCase` æ™‚è‡ªå‹•åŸ·è¡Œ
- åœ¨æ‰€æœ‰ class-scope fixture ä¸­æœ€å…ˆåŸ·è¡Œ
- æä¾› `cls.reboot_mgr` çµ¦å…¶ä»– fixture ä½¿ç”¨

### TestSTC1685BurnIN.setup_test_class çš„ä½œç”¨èˆ‡æ™‚æ©Ÿ

**ä½œç”¨ï¼š**
1. **æä¾›å°ˆå±¬çš„æ¸¬è©¦è¨­å®š**ï¼ˆåªé©ç”¨æ–¼ STC-1685ï¼‰
   - åˆ‡æ›åˆ°æ¸¬è©¦ç›®éŒ„
   - è¼‰å…¥å°ˆå±¬çš„ Config.json
   - è¨­å®šå·¥å…·è·¯å¾‘

2. **ç¾åœ¨ä¹Ÿæ”¯æ´é‡å•Ÿæª¢æ¸¬**
   ```python
   is_recovering = cls.reboot_mgr.is_recovering()
   if not is_recovering:
       # é¦–æ¬¡åŸ·è¡Œï¼šå®Œæ•´åˆå§‹åŒ–
       logger.logConfig()
       logger.LogEvt("STC-1685: BurnIN Test Starting")
   else:
       # é‡å•Ÿå¾Œï¼šåªè¨˜éŒ„æ¢å¾©è¨Šæ¯
       logger.LogEvt("STC-1685: Recovering from reboot")
   ```

**ä½¿ç”¨æ™‚æ©Ÿï¼š**
- åœ¨ `BaseTestCase.setup_teardown_class` ä¹‹å¾ŒåŸ·è¡Œ
- å¯ä»¥ä½¿ç”¨ `cls.reboot_mgr` ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºé‡å•Ÿæ¢å¾©

### ç‚ºä»€éº¼æŸäº›å‹•ä½œé‡å•Ÿå¾Œé‚„è¦åŸ·è¡Œï¼Ÿ

#### é‡å•Ÿå¾Œéœ€è¦é‡æ–°åŸ·è¡Œçš„å‹•ä½œ âœ…

1. **è¼‰å…¥é…ç½®æª”æ¡ˆ**
   ```python
   with open(config_path) as f:
       cls.config = json.load(f)
   ```
   - åŸå› ï¼šæ–°çš„ Python ç¨‹åºï¼Œè¨˜æ†¶é«”ä¸­çš„è³‡æ–™å·²æ¸…ç©º
   - å¿…é ˆé‡æ–°è¼‰å…¥è¨­å®š

2. **åˆ‡æ›å·¥ä½œç›®éŒ„**
   ```python
   os.chdir(test_dir)
   ```
   - åŸå› ï¼šæ–°çš„ç¨‹åºï¼Œå·¥ä½œç›®éŒ„å¯èƒ½ä¸åŒ
   - å¿…é ˆé‡æ–°è¨­å®š

3. **è¨­å®šå·¥å…·è·¯å¾‘**
   ```python
   cls.bin_path = Path(__file__).parent / "bin"
   ```
   - åŸå› ï¼šé¡åˆ¥è®Šæ•¸éœ€è¦é‡æ–°è¨­å®š

#### é‡å•Ÿå¾Œå¯ä»¥è·³éçš„å‹•ä½œ âŒ

1. **åˆå§‹åŒ– logger**
   ```python
   if not is_recovering:
       logger.logConfig()  # åªåœ¨é¦–æ¬¡åŸ·è¡Œ
   ```
   - åŸå› ï¼šé¿å…é‡è¤‡é…ç½®æ—¥èªŒç³»çµ±

2. **é¡¯ç¤ºå•Ÿå‹•è¨Šæ¯**
   ```python
   if not is_recovering:
       logger.LogEvt("STC-1685: BurnIN Test Starting")
   else:
       logger.LogEvt("STC-1685: Recovering from reboot")
   ```
   - åŸå› ï¼šå€åˆ†é¦–æ¬¡åŸ·è¡Œå’Œé‡å•Ÿæ¢å¾©

3. **å»ºç«‹æ¸¬è©¦ç›®éŒ„**ï¼ˆåœ¨ BaseTestCase ä¸­ï¼‰
   ```python
   if not cls.reboot_mgr.is_recovering():
       setup_test_environment(cls.log_path)  # åªåœ¨é¦–æ¬¡åŸ·è¡Œ
   ```
   - åŸå› ï¼šç›®éŒ„å·²å­˜åœ¨ï¼Œé¿å…æ¸…é™¤æ¸¬è©¦è³‡æ–™

### å¦‚ä½•åˆ¤æ–·æ˜¯å¦ç‚ºé‡å•Ÿæ¢å¾©ï¼Ÿ

**åœ¨ setup_test_class ä¸­ä½¿ç”¨ reboot_mgrï¼š**
```python
@pytest.fixture(scope="class", autouse=True)
def setup_test_class(self, request):
    cls = request.cls
    
    # å–å¾— BaseTestCase å»ºç«‹çš„ reboot_mgr
    is_recovering = cls.reboot_mgr.is_recovering()
    
    if not is_recovering:
        # é¦–æ¬¡åŸ·è¡Œçš„åˆå§‹åŒ–
        do_first_time_setup()
    else:
        # é‡å•Ÿå¾Œçš„æ¢å¾©
        do_recovery_setup()
```

### è¨­è¨ˆå„ªå‹¢

âœ… **åˆ†å±¤è² è²¬**
- BaseTestCaseï¼šé€šç”¨æ¡†æ¶åŠŸèƒ½
- å­é¡åˆ¥ fixtureï¼šå°ˆå±¬è¨­å®š

âœ… **éˆæ´»æ§åˆ¶**
- å¯ä»¥è‡ªå·±æ±ºå®šå“ªäº›å‹•ä½œè¦åœ¨é‡å•Ÿå¾ŒåŸ·è¡Œ
- å¯ä»¥è‡ªå·±æ±ºå®šå“ªäº›å‹•ä½œè¦è·³é

âœ… **ç‹€æ…‹å…±äº«**
- `cls.reboot_mgr` åœ¨æ‰€æœ‰ fixture ä¸­éƒ½å¯ç”¨
- çµ±ä¸€çš„é‡å•Ÿç‹€æ…‹ç®¡ç†

âœ… **å¯ç¶­è­·æ€§**
- ä¿®æ”¹é€šç”¨åŠŸèƒ½ä¸å½±éŸ¿ç‰¹å®šé‚è¼¯
- ä¿®æ”¹ç‰¹å®šé‚è¼¯ä¸å½±éŸ¿å…¶ä»–æ¸¬è©¦æ¡ˆä¾‹  

---

## 5. å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### å­˜å–é…ç½®
```python
def test_02_install_burnin(self):
    # ä½¿ç”¨ setup_test_class è¼‰å…¥çš„é…ç½®
    burnin.SetConfig(self.config['burnin'])
```

### å­˜å–å·¥å…·è·¯å¾‘
```python
def test_xx_something(self):
    # ä½¿ç”¨ setup_test_class è¨­å®šçš„è·¯å¾‘
    tool_path = self.bin_path / "tool.exe"
```

### ä½¿ç”¨ BaseTestCase çš„æ–¹æ³•
```python
def test_xx_something(self):
    # ä½¿ç”¨ç¹¼æ‰¿çš„è¼”åŠ©æ–¹æ³•
    timeout = self.get_config('timeout', 3600)
    self.log("æ¸¬è©¦é–‹å§‹")
```

---

## 6. é‡å•Ÿæ¢å¾©æ©Ÿåˆ¶èªªæ˜

### é‡å•Ÿå¾Œçš„åŸ·è¡Œè¡Œç‚º

ç•¶æ¸¬è©¦éœ€è¦é‡å•Ÿç³»çµ±æ™‚ï¼ˆä¾‹å¦‚é©…å‹•ç¨‹å¼å®‰è£ï¼‰ï¼Œ`BaseTestCase` æä¾›è‡ªå‹•æ¢å¾©åŠŸèƒ½ã€‚

### é—œéµå•é¡Œï¼šé‡å•Ÿå¾Œå“ªäº›æœƒåŸ·è¡Œï¼Ÿå“ªäº›æœƒè·³éï¼Ÿ

#### âœ… é‡å•Ÿå¾Œä»æœƒåŸ·è¡Œçš„éƒ¨åˆ†

1. **Class-scope fixtures éƒ½æœƒé‡æ–°åŸ·è¡Œ**
   ```
   âœ“ BaseTestCase.setup_teardown_class æœƒåŸ·è¡Œ
   âœ“ TestSTC1685BurnIN.setup_test_class æœƒåŸ·è¡Œ
   ```
   
2. **ä½†å…§éƒ¨æœ‰æ¢ä»¶åˆ¤æ–·ï¼Œæ§åˆ¶æŸäº›å‹•ä½œæ˜¯å¦åŸ·è¡Œ**
   ```python
   # BaseTestCase.setup_teardown_class ä¸­
   if not cls.reboot_mgr.is_recovering():
       # é¦–æ¬¡åŸ·è¡Œï¼šå®Œæ•´åˆå§‹åŒ–
       setup_test_environment(cls.log_path)  â† åªåœ¨é¦–æ¬¡åŸ·è¡Œ
   else:
       # é‡å•Ÿå¾Œï¼šè·³éç’°å¢ƒåˆå§‹åŒ–
       print("Recovering test...")  â† é‡å•Ÿå¾ŒåŸ·è¡Œ
   ```

#### âŒ é‡å•Ÿå¾Œæœƒè·³éçš„éƒ¨åˆ†

1. **å·²å®Œæˆçš„æ¸¬è©¦ä¸æœƒé‡è¤‡åŸ·è¡Œ**
   ```python
   # BaseTestCase.setup_teardown_function ä¸­
   if self.reboot_mgr.is_completed(test_name):
       pytest.skip(f"{test_name} already completed")
   ```

2. **ç’°å¢ƒåˆå§‹åŒ–å‹•ä½œæœƒè¢«è·³é**
   - `setup_test_environment()` åªåœ¨é¦–æ¬¡åŸ·è¡Œ
   - é¿å…é‡è¤‡å‰µå»ºç›®éŒ„æˆ–åˆå§‹åŒ–è³‡æº

### å®Œæ•´çš„é‡å•Ÿæµç¨‹ç¯„ä¾‹

å‡è¨­åœ¨ `test_03` éœ€è¦é‡å•Ÿï¼š

#### ç¬¬ä¸€æ¬¡åŸ·è¡Œï¼ˆé‡å•Ÿå‰ï¼‰
```
æ¸¬è©¦é–‹å§‹
    â†“
BaseTestCase.setup_teardown_class (å®Œæ•´åˆå§‹åŒ–)
    â†“
TestSTC1685BurnIN.setup_test_class (å®Œæ•´åˆå§‹åŒ–)
    â†“
test_01_precondition âœ“ åŸ·è¡Œä¸¦æ¨™è¨˜å®Œæˆ
    â†“
test_02_install_burnin âœ“ åŸ·è¡Œä¸¦æ¨™è¨˜å®Œæˆ
    â†“
test_03_install_driver 
    â†’ åŸ·è¡Œå®‰è£
    â†’ å‘¼å« self.reboot_mgr.schedule_reboot()
    â†’ âœ“ æ¨™è¨˜å®Œæˆ
    â†’ ç³»çµ±é‡å•Ÿ ğŸ”„
```

#### é‡å•Ÿå¾ŒåŸ·è¡Œ
```
æ¸¬è©¦é–‹å§‹ï¼ˆpytest è‡ªå‹•é‡æ–°å•Ÿå‹•ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BaseTestCase.setup_teardown_class                           â”‚
â”‚   â†’ âœ“ åŸ·è¡Œï¼ˆæª¢æ¸¬åˆ° is_recovering() = Trueï¼‰                 â”‚
â”‚   â†’ âœ— è·³é setup_test_environment()                        â”‚
â”‚   â†’ åªåšæœ€å°åŒ–çš„æ¢å¾©è¨­å®š                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TestSTC1685BurnIN.setup_test_class                          â”‚
â”‚   â†’ âœ“ æª¢æ¸¬åˆ° is_recovering = True                          â”‚
â”‚   â†’ âœ“ åˆ‡æ›å·¥ä½œç›®éŒ„                                           â”‚
â”‚   â†’ âœ“ é‡æ–°è¼‰å…¥ Config.json                                  â”‚
â”‚   â†’ âœ— è·³é logger.logConfig()                              â”‚
â”‚   â†’ âœ“ é¡¯ç¤ºæ¢å¾©è¨Šæ¯ï¼š"STC-1685: Recovering from reboot"      â”‚
â”‚   â†’ âœ“ è¨­å®š bin_path                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¸¬è©¦å‡½æ•¸åŸ·è¡Œï¼ˆåªåŸ·è¡Œæœªå®Œæˆçš„æ¸¬è©¦ï¼‰                             â”‚
â”‚                                                             â”‚
â”‚   test_01_precondition                                      â”‚
â”‚     â†’ âœ— æª¢æ¸¬åˆ°å·²å®Œæˆï¼Œè·³é                                   â”‚
â”‚                                                             â”‚
â”‚   test_02_install_burnin                                    â”‚
â”‚     â†’ âœ— æª¢æ¸¬åˆ°å·²å®Œæˆï¼Œè·³é                                   â”‚
â”‚                                                             â”‚
â”‚   test_03_install_driver                                    â”‚
â”‚     â†’ âœ— æª¢æ¸¬åˆ°å·²å®Œæˆï¼Œè·³éï¼ˆé€™å€‹æ¸¬è©¦è§¸ç™¼äº†é‡å•Ÿï¼‰              â”‚
â”‚                                                             â”‚
â”‚   test_04_verify_driver                                     â”‚
â”‚     â†’ âœ“ å¾é€™è£¡ç¹¼çºŒåŸ·è¡Œï¼ˆé©—è­‰é©…å‹•ç¨‹å¼ï¼‰                        â”‚
â”‚                                                             â”‚
â”‚   test_05_run_test                                          â”‚
â”‚     â†’ âœ“ ç¹¼çºŒåŸ·è¡Œ                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ¸¬è©¦ç¹¼çºŒ...
```

### å¯¦éš›ä½¿ç”¨ç¯„ä¾‹

```python
class TestWithReboot(BaseTestCase):
    
    @pytest.fixture(scope="class", autouse=True)
    def setup_test_class(self, request):
        """é€™å€‹ fixture é‡å•Ÿå¾Œé‚„æ˜¯æœƒåŸ·è¡Œï¼Œä½†å¯ä»¥æ ¹æ“šç‹€æ…‹æ±ºå®šè¡Œç‚º"""
        cls = request.cls
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºé‡å•Ÿæ¢å¾©
        is_recovering = cls.reboot_mgr.is_recovering()
        
        # é€™äº›å‹•ä½œé‡å•Ÿå¾Œé‚„æ˜¯æœƒåŸ·è¡Œï¼ˆå¿…è¦çš„è¨­å®šï¼‰
        cls.config = load_config()       # âœ“ é‡å•Ÿå¾Œé‡æ–°è¼‰å…¥
        os.chdir(test_directory)         # âœ“ é‡å•Ÿå¾Œé‡æ–°åˆ‡æ›
        
        # é€™äº›å‹•ä½œæ ¹æ“šç‹€æ…‹æ±ºå®šæ˜¯å¦åŸ·è¡Œ
        if not is_recovering:
            # é¦–æ¬¡åŸ·è¡Œ
            logger.logConfig()           # âœ“ é¦–æ¬¡åŸ·è¡Œ
            logger.LogEvt("Test Starting")
        else:
            # é‡å•Ÿå¾Œæ¢å¾©
            logger.LogEvt("Recovering from reboot")  # âœ“ é‡å•Ÿå¾ŒåŸ·è¡Œ
        
        yield
    
    def test_01_before_reboot(self):
        """é‡å•Ÿå‰çš„æ¸¬è©¦"""
        install_driver()
        self.reboot_mgr.schedule_reboot()  # å®‰æ’é‡å•Ÿ
        # é€™å€‹æ¸¬è©¦å®Œæˆå¾Œæœƒè¢«æ¨™è¨˜ç‚ºå·²å®Œæˆ
    
    def test_02_after_reboot(self):
        """é‡å•Ÿå¾Œçš„æ¸¬è©¦"""
        # é‡å•Ÿå¾Œæœƒå¾é€™è£¡ç¹¼çºŒåŸ·è¡Œ
        verify_driver()
```

### è¨­è¨ˆåŸç†

**ç‚ºä»€éº¼ setup_test_class é‚„æ˜¯è¦åŸ·è¡Œï¼Ÿ**
- é…ç½®éœ€è¦é‡æ–°è¼‰å…¥ï¼ˆæ–°çš„ Python ç¨‹åºï¼Œè¨˜æ†¶é«”å·²æ¸…ç©ºï¼‰
- å·¥ä½œç›®éŒ„éœ€è¦é‡æ–°è¨­å®šï¼ˆæ–°çš„ç¨‹åºç’°å¢ƒï¼‰
- é¡åˆ¥è®Šæ•¸éœ€è¦é‡æ–°åˆå§‹åŒ–ï¼ˆbin_path ç­‰ï¼‰

**ç‚ºä»€éº¼å¯ä»¥åœ¨ setup_test_class ä¸­è·³éæŸäº›å‹•ä½œï¼Ÿ**
- é€é `cls.reboot_mgr.is_recovering()` åˆ¤æ–·ç‹€æ…‹
- é¦–æ¬¡åŸ·è¡Œï¼šå®Œæ•´åˆå§‹åŒ–ï¼ˆlogger.logConfig()ã€é¡¯ç¤ºå•Ÿå‹•è¨Šæ¯ï¼‰
- é‡å•Ÿå¾Œï¼šè·³éåˆå§‹åŒ–ï¼Œåªé¡¯ç¤ºæ¢å¾©è¨Šæ¯

**ç‚ºä»€éº¼ BaseTestCase è¦è·³é setup_test_environmentï¼Ÿ**
- æ¸¬è©¦ç›®éŒ„å·²ç¶“å­˜åœ¨ï¼Œä¸éœ€è¦é‡è¤‡å‰µå»º
- é¿å…æ¸…é™¤å·²ç”¢ç”Ÿçš„æ¸¬è©¦è³‡æ–™ï¼ˆlogã€æ¸¬è©¦è¼¸å‡ºç­‰ï¼‰
- ä¿ç•™é‡å•Ÿå‰çš„æ¸¬è©¦ç‹€æ…‹å’Œè³‡æ–™

**æœ€ä½³å¯¦è¸ï¼š**
```python
# åœ¨ setup_test_class ä¸­çš„åˆ¤æ–·é‚è¼¯
is_recovering = cls.reboot_mgr.is_recovering()

if not is_recovering:
    # åªåœ¨é¦–æ¬¡åŸ·è¡Œçš„åˆå§‹åŒ–
    - é…ç½®æ—¥èªŒç³»çµ±
    - é¡¯ç¤ºæ¸¬è©¦é–‹å§‹è¨Šæ¯
    - å»ºç«‹åˆå§‹è³‡æº
else:
    # é‡å•Ÿå¾Œçš„æ¢å¾©
    - é¡¯ç¤ºæ¢å¾©è¨Šæ¯
    - ä¸è¦é‡è¤‡åˆå§‹åŒ–

# ç„¡è«–æ˜¯å¦é‡å•Ÿéƒ½è¦åŸ·è¡Œçš„å‹•ä½œ
- è¼‰å…¥é…ç½®æª”æ¡ˆï¼ˆè¨˜æ†¶é«”å·²æ¸…ç©ºï¼‰
- åˆ‡æ›å·¥ä½œç›®éŒ„ï¼ˆæ–°ç¨‹åºç’°å¢ƒï¼‰
- è¨­å®šé¡åˆ¥è®Šæ•¸ï¼ˆéœ€è¦é‡æ–°è¨­å®šï¼‰
```

---

## ç¸½çµ

- **setup_test_class**ï¼šç‚º STC-1685 æ¸¬è©¦æä¾›å°ˆå±¬çš„åˆå§‹åŒ–è¨­å®š
- **BaseTestCase**ï¼šæä¾›æ¸¬è©¦æ¡†æ¶çš„æ¨™æº–åŠŸèƒ½ï¼ˆé‡å•Ÿæ¢å¾©ã€ç‹€æ…‹ç®¡ç†ã€è¼”åŠ©æ–¹æ³•ï¼‰
- **ç¹¼æ‰¿è¨­è¨ˆ**ï¼šçµåˆé€šç”¨åŠŸèƒ½èˆ‡ç‰¹å®šéœ€æ±‚ï¼Œæä¾›éˆæ´»ä¸”å¯ç¶­è­·çš„æ¸¬è©¦æ¶æ§‹
